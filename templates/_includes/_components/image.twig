{% spaceless %}
  {#
  ##########################################################################################
    ###Image
    This generates webp with jpeg fallbacks and use picture to deliver the correct images.
    Uses Srcset and Sizes for delivering suitable images based on screen resolution and uses lazysizes for performance.

    @param image :: {object} (the image to apply the transform to)
    @param transform :: {string} (set a transform from the array of transforms below. e.g transform:'16x9')
    @param alt :: {string or object}
    @param focalPoint :: {}
    @param lazyLoad :: {bool}
    @param classes :: {array} (optional)
    @param widthStart :: {int} (optional) (is the starting transform size for the srcset. e.g widthStart:300)
    @param widthEnd :: {int} (optional) (is the ending transform size for the srcset. e.g widthEnd:2000)
    @param sizes :: {string} (what sizes to set for the image. e.g sizes:'(min-width:992px) 10rem, (min-width:576px) 50vw, 100vw' ?? 'auto' for lazysizes auto sizing ?? falls back to natural image width.)
    @param effects :: {array} (optional) (any effects to apply to the image e.g effects:{modulate: [100, 40, 100], colorBlend: ['rgb(255, 153, 51)', 0.5]} )

    #USAGE:
    {% include
      '_includes/_components/image.twig' with {
        image:image,
        transform: 'portrait',
        alt: 'entry.title',
        lazyLoad: 0,
        classes:'w-1/4 border',
        srcWidth:600,
        widthStart:200,
        widthEnd:800,
        sizes:'(min-width:992px) 10rem, (min-width:576px) 50vw, 100vw',
        effects:{modulate: [100, 40, 100], colorBlend: ['rgb(255, 153, 51)', 0.5]}
      }
    %}

  ##########################################################################################
  #}
  
  {# Parameters #}
  {% set alt = alt|default(image.alt|default(image.title)) %}
  {% set focalPoint = image.getFocalPoint() %}
  {% set lazyLoad = lazyLoad|default(1) %}
  {% set sizes = sizes|default(image.width ~ 'px') %}
  {% set classes = classes|default('') %}
  {% set effects = effects ?? {} %}
  
  {# Notes
    #########
    Setting the images for the fill transforms. This allows us to pass in the smallest image to start from and the largest image to transform up to.
    The reason we do this is so we can pass in smaller image ranges where we won't need lots of transforms, such as thumbnails and crops.

    The second aspect allows us to check the largest image size. If the source image is smaller than 'widthEnd' then we set the 'widthEnd' to be the value of the largest image. This means we don't get unnecessary transforms and we don't get incorrect srcsizes as Imager outputs correct code.

    'widthStart'      is the starting transform size.
    'widthEnd'        is the ending transform size.
    'largestImage     checks the integrity of the image width for the transforms and sets this correctly.
    '#########
  #}
  
  {% set widthStart = widthStart|default(300) %}
  {% set widthEnd = widthEnd|default(2000) %}
  {% set srcWidth = srcWidth|default(widthStart) %}
  {% set fillInterval = fillInterval|default(300) %}
  
  {% set largestImage = (image.width < widthEnd ? image.width : widthEnd) %}
  {% set imageSizes = [
    { width: largestImage },
    { width: widthStart }
  ] %}
  
  {# Notes
    #########
    The 'placeholder' image is used for the blur-up technique in lazysizes.
    #########
  #}
  {% set placeholder = {
    width: 50,
    quality: 15,
  } %}
  
  
  {% set transforms = {
    'base': {
      mode: 'crop',
      ratio: image.width / image.height,
      position:focalPoint,
      effects: effects,
    },
    'square': {
      mode: 'crop',
      ratio: 1,
      position:focalPoint,
      effects: effects,
    },
    'bannerThin': {
      mode: 'crop',
      ratio: 16/6.6,
      position:focalPoint,
      effects: effects,
    },
    '16x9': {
      mode: 'crop',
      ratio: 16/9,
      position:focalPoint,
      effects: effects,
    },
    '16x10': {
      mode: 'crop',
      ratio: 16/10,
      position:focalPoint,
      effects: effects,
    },
    'portrait': {
      mode: 'crop',
      ratio:5/7,
      position:focalPoint,
      effects: effects,
    },
    'logo': {
      mode: 'letterbox',
      ratio:1/0.66,
      position:focalPoint,
      effects: effects,
      letterbox: { color: '#FFF', opacity: 1 }
    }
  } %}
  
  {% set transform = attribute(transforms, transform) %}
{% endspaceless %}

{# OUTPUT #}
<picture>
  {% if image.extension == 'svg' %}
    {{ svg(image, class=classes) }}
  {% else %}
    {% set placeholder = craft.imager.transformImage(image, placeholder, transform|merge({effects: {blur: 1}})) %}
    {% set srcImage = craft.imager.transformImage(image, {width:srcWidth}, transform) %}
    {% set transformedImages = craft.imager.transformImage(image, imageSizes, transform, { fillTransforms: true, fillInterval:fillInterval }) %}
    {% if craft.imager.serverSupportsWebp %}
      {% set transform = transform|merge({format: 'webp'}) %}
      {% set transformedImagesWebp = craft.imager.transformImage(image, imageSizes, transform, { fillTransforms: true, fillInterval:fillInterval }) %}
    {% endif %}
    {% if lazyLoad != 0 %}
      {% if craft.imager.serverSupportsWebp() %}
        <source sizes="{{ sizes }}" data-srcset="{{ transformedImagesWebp|srcset }}" type="image/webp">
      {% endif %}
      <img
        class="lazyload {{ classes }}"
        src="{{ placeholder.url }}"
        data-src="{{ srcImage.url }}"
        data-srcset="{{ transformedImages|srcset }}"
        data-sizes="{{ sizes }}"
        alt="{{ alt }}"
      />
    {% else %}
      {% if craft.imager.serverSupportsWebp() %}
        <source sizes="{{ sizes }}" srcset="{{ transformedImagesWebp|srcset }}" type="image/webp">
      {% endif %}
      <img
        class="{{ classes }}"
        src="{{ srcImage.url }}"
        srcset="{{ transformedImages|srcset }}"
        sizes="{{ sizes }}"
        alt="{{ alt }}"
      />
    {% endif %}
  {% endif %}
</picture>